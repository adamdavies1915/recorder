name: Record WHIV Radio Stream

on:
  schedule:
    # Every Tuesday at 7pm US Central Time (CST = UTC-6)
    # 7pm CST = 1:00 AM UTC Wednesday
    # NOTE: Adjust to "0 0 * * 3" during Daylight Saving Time (CDT = UTC-5)
    - cron: '0 1 * * 3'
  workflow_dispatch:
    # Allow manual triggering for testing

jobs:
  record:
    runs-on: ubuntu-latest
    timeout-minutes: 70

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Set timestamp for filename
        id: timestamp
        run: |
          # Use Central Time for the filename
          TIMESTAMP=$(TZ="America/Chicago" date +"%Y%m%d_%H%M")
          echo "filename=whiv_${TIMESTAMP}.mp3" >> $GITHUB_OUTPUT
          echo "Recording will be saved as: whiv_${TIMESTAMP}.mp3"

      - name: Record stream
        run: |
          echo "Starting recording at $(date)"
          echo "Stream URL: http://peridot.streamguys.com:5080/live-mp3"
          echo "Duration: 3660 seconds (1 hour + 1 minute buffer)"
          echo ""
          ffmpeg -i http://peridot.streamguys.com:5080/live-mp3 \
            -t 3660 \
            -c copy \
            -y \
            "${{ steps.timestamp.outputs.filename }}"
          echo ""
          echo "Recording completed at $(date)"

      - name: Log file size
        run: |
          echo "Recording file details:"
          ls -lh "${{ steps.timestamp.outputs.filename }}"
          SIZE=$(du -h "${{ steps.timestamp.outputs.filename }}" | cut -f1)
          echo ""
          echo "File size: ${SIZE}"

      - name: Upload recording as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.timestamp.outputs.filename }}
          path: ${{ steps.timestamp.outputs.filename }}
          retention-days: 30
